<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดพฤติกรรมลูกค้า</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }
        .card {
            background-color: #1e293b;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .bar-chart-container {
            position: relative;
            width: 100%;
            height: 400px;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 1rem;
        }
        /* Style for scrollbar */
        .table-container::-webkit-scrollbar {
            width: 10px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 10px;
            border: 2px solid #1e293b;
        }
    </style>
</head>
<body class="text-white p-4 sm:p-10">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
            แดชบอร์ดพฤติกรรมลูกค้า
        </h1>
        <p class="text-center text-gray-400 mb-12 text-lg">สรุปข้อมูลเชิงลึกจากพฤติกรรมการซื้อ</p>

        <!-- Cards Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <div class="card flex flex-col justify-center items-center text-center">
                <span id="total-users" class="text-6xl sm:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500">...</span>
                <p class="mt-4 text-gray-300 text-lg">จำนวนผู้ใช้งานทั้งหมด</p>
            </div>
            <div class="card flex flex-col justify-center items-center text-center">
                <span id="avg-satisfaction" class="text-6xl sm:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">...</span>
                <p class="mt-4 text-gray-300 text-lg">คะแนนความพึงพอใจเฉลี่ย</p>
            </div>
        </div>

        <!-- Bar Chart Section -->
        <div class="bg-gray-800 p-6 sm:p-10 rounded-3xl shadow-2xl mb-12">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-center text-gray-200">แพลตฟอร์มที่ได้รับความนิยม</h2>
            <div class="bar-chart-container">
                <canvas id="platform-chart"></canvas>
            </div>
        </div>

        <!-- Filterable Table Section -->
        <div class="bg-gray-800 p-6 sm:p-10 rounded-3xl shadow-2xl">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-center text-gray-200">ข้อมูลทั้งหมด</h2>
            <div class="mb-6 flex flex-col sm:flex-row justify-end items-center sm:space-x-4 space-y-4 sm:space-y-0">
                <input type="text" id="searchInput" placeholder="ค้นหาข้อมูล..." class="w-full sm:w-1/3 p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ลูกค้า</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">อายุ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">เพศ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">รายได้</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">การศึกษา</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ที่ตั้ง</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ความถี่</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">แพลตฟอร์ม</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ยอดใช้จ่ายเฉลี่ย</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">วิธีชำระเงิน</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">หมวดหมู่สินค้า</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">คะแนนความพึงพอใจ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">แนวโน้มการแนะนำ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">วันจากการซื้อล่าสุด</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-gray-700">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let data = [];
            
            const googleSheetsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTrzQf2kVGxZhVlafMQr6OQ2KB3ifGX9gfTdM2v9uteM09XFN6iMWAcyfhNrwZ_I7xoWK1h3JoWiv4V/pub?gid=0&single=true&output=csv';

            async function fetchData() {
                try {
                    const response = await fetch(googleSheetsUrl);
                    const csvText = await response.text();
                    data = parseCSV(csvText);
                    renderCards();
                    renderBarChart();
                    renderTable();
                } catch (error) {
                    console.error('Error fetching data from Google Sheets:', error);
                }
            }

            function parseCSV(csv) {
                const lines = csv.trim().split('\n');
                const headers = lines[0].split(',');
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    return headers.reduce((obj, header, index) => {
                        obj[header] = values[index];
                        return obj;
                    }, {});
                });
            }

            function renderCards() {
                if (data.length === 0) {
                    document.getElementById('total-users').innerText = '0';
                    document.getElementById('avg-satisfaction').innerText = '0.00';
                    return;
                }
                const totalUsers = data.length;
                const totalSatisfaction = data.reduce((sum, row) => sum + parseFloat(row.satisfaction_score), 0);
                const avgSatisfaction = (totalSatisfaction / totalUsers).toFixed(2);

                document.getElementById('total-users').innerText = totalUsers;
                document.getElementById('avg-satisfaction').innerText = avgSatisfaction;
            }

            function renderBarChart() {
                if (data.length === 0) return;

                const platforms = data.reduce((acc, row) => {
                    acc[row.preferred_platform] = (acc[row.preferred_platform] || 0) + 1;
                    return acc;
                }, {});

                const platformLabels = Object.keys(platforms);
                const platformCounts = Object.values(platforms);

                const canvas = document.getElementById('platform-chart');
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = 50;
                const spacing = (canvas.width - (barWidth * platformLabels.length)) / (platformLabels.length + 1);
                const maxCount = Math.max(...platformCounts);
                const chartHeight = canvas.height - 50;
                const chartY = canvas.height - 40;

                platformLabels.forEach((label, index) => {
                    const count = platformCounts[index];
                    const barHeight = (count / maxCount) * chartHeight;
                    const x = spacing + index * (barWidth + spacing);
                    const y = chartY - barHeight;

                    // Bar
                    const gradient = ctx.createLinearGradient(0, y, 0, chartY);
                    gradient.addColorStop(0, '#60a5fa');
                    gradient.addColorStop(1, '#818cf8');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, y, barWidth, barHeight);

                    // Count label
                    ctx.fillStyle = '#cbd5e1';
                    ctx.font = '16px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText(count, x + barWidth / 2, y - 5);

                    // Platform label
                    ctx.fillStyle = '#94a3b8';
                    ctx.font = '14px Inter';
                    ctx.fillText(label, x + barWidth / 2, chartY + 20);
                });
            }

            function renderTable(filterTerm = '') {
                const tableBody = document.getElementById('dataTableBody');
                tableBody.innerHTML = '';
                
                const filteredData = data.filter(row => {
                    if (!filterTerm) return true;
                    return Object.values(row).some(value => 
                        String(value).toLowerCase().includes(filterTerm.toLowerCase())
                    );
                });

                filteredData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-700 transition-colors duration-200';
                    tr.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.customer_id}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.age}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.gender}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.income_level}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.education}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.location}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.shopping_frequency}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.preferred_platform}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">฿${row.avg_spending}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.payment_method}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.product_category}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.satisfaction_score}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.recommendation_likelihood}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-200">${row.last_purchase_days}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
            
            // Add event listener for filtering
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                renderTable(e.target.value);
            });

            // Handle window resize for the chart
            window.addEventListener('resize', renderBarChart);
            
            // Fetch data from Google Sheets on page load
            fetchData();
        });
    </script>
</body>
</html>
